---
title: "SURV727 Final Project"
author: "Akari Oya, Zhouer Wang"
format: html
---
# Github link: <https://github.com/ZuorW/SURV727.git>


```{r, include = FALSE}
library(tidyverse)
```


## Proposal:
weather data vs gtrends data for seasonal depression-related words

## Open Meteo API
```{r}
# Load necessary package
library(openmeteo)

# see which weather variables we have data for (not a complete list)
weather_variables()

# Pulling one city's dataset
# we probably can't use Ann Arbor since we couldn't locate gtrends to Ann Arbor
# cities we could use = 

weather <- weather_history("Detroit",
  start = "2017-12-01",
  end = "2023-12-01",
  daily = "daylight_duration") # pulling for dayling duration

# Check data
str(weather)
head(weather) # daylight seems to be in seconds

```

```{r}
# Manipulate/clean dataset
# Add column for city
weather$city <- "Detroit"

# Add column for daylight by hour
weather$daylight_hrs <- weather$daily_daylight_duration/ 3600

head(weather)

weather_weekly <- weather %>% 
  mutate(week = week(ymd(date))) %>% 
  group_by(week) %>% 
  summarise(daily_daylight_duration = mean(daily_daylight_duration),
            daylight_hrs = mean(daylight_hrs))

# Aggregate weekly data so it matches gtrends
week <- as.Date(cut(weather$date, "week"))
daylight_weekly <- aggregate(daily_daylight_duration ~ week, weather, sum)

# Add column for daylight by hour
daylight_weekly$daily_hrs <- daylight_weekly$daily_daylight_duration/ 3600

head(daylight_weekly)
```

```{r}
# Create loop to grab all cities of interest
# First, create list of cities of interest
cities <- c("Ann Arbor", "Lansing", "Grand Rapids", "Kalamazoo")

# we use weather_history() to get historical weather data
for(i in cities) {
other_weather <- weather_history(i,
  start = "2017-12-01",
  end = "2023-12-01",
  daily = "daylight_duration")

  other_weather2 <- subset(other_weather, select = -c(date))
  other_weather2$daylight_hrs <- other_weather2$daily_daylight_duration / 3600 #create daylight by hour column
  other_weather2$city <- i # add city column

  weather <- cbind(weather, other_weather2) # combine datasets
}

head(weather)

```

```{r}

library(gtrendsR)
res <- gtrends(c("antidepressants", "depression"), 
               geo = "US-MI", 
               time = "2020-01-01 2020-12-31", 
               low_search_volume = TRUE)
plot(res)

#transform the data.frame into tibble
rest_city <- tibble(res$interest_by_city)

#reshape the data & sort loans column in descending order
city_ranking <- rest_city %>%
  pivot_wider(names_from = keyword, 
              values_from = hits) %>%
  arrange(., desc(loans))

#display first few rows of the ranking to find the highest searched
head(city_ranking)
```

